<!doctype html>
<html class="member-page" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title layout:title-pattern="$LAYOUT_TITLE | $CONTENT_TITLE">eBookLand</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/js/websocket.js"></script> <!-- âœ… ê³µí†µ WebSocket ì‚¬ìš© -->

    <link rel="stylesheet" th:href="@{/css/chat/chat.css}">
</head>

<body>

<header th:replace="~{fragments/header::headerFragment}"></header>

<main layout:fragment="main"></main>

<footer th:replace="~{fragments/footer::footerFragment}"></footer>

<script layout:fragment="js"></script>

<!-- âœ… ì±„íŒ… ë²„íŠ¼ (íšŒì›ë§Œ ì ‘ê·¼ ê°€ëŠ¥) -->
<div class="chat-icon" onclick="toggleChat()" sec:authorize="hasRole('MEMBER')">
    ğŸ’¬
</div>

<!-- âœ… íšŒì› ì±„íŒ…ì°½ -->
<div class="chat-window" id="chatWindow">
    <div class="chat-header" onclick="toggleChat()">1:1 ì±„íŒ…</div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-input">
        <input type="text" id="chatMessage" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>
<script>
    var roomId = null;
    var nickName = null;

    // âœ… ì±„íŒ…ì°½ í† ê¸€ (ë²„íŠ¼ ì˜†ì— ìœ„ì¹˜)
    function toggleChat() {
        var chatWindow = document.getElementById("chatWindow");

        if (chatWindow.style.display === "flex") {
            chatWindow.style.display = "none"; // ë‹«ê¸°
        } else {
            chatWindow.style.display = "flex"; // ì—´ê¸°
        }
    }


    // âœ… íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸° ë° WebSocket ì—°ê²°
    function fetchUserInfoAndConnect() {
        fetch('/member/api/member/roomId')
            .then(response => {
                if (response.redirected) {
                    console.warn("ğŸš¨ ë¡œê·¸ì¸ í•„ìš” - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™");
                    window.location.href = response.url;
                    return Promise.reject("ë¡œê·¸ì¸ í•„ìš”");
                }
                return response.json();
            })
            .then(data => {
                if (data.roomId !== "0") {
                    roomId = data.roomId;
                    nickName = data.nickName;
                    console.log(`âœ… roomId=${roomId}, nickName=${nickName}`);

                    // âœ… ê³µí†µ WebSocketì´ ì—°ê²°ëœ ìƒíƒœì—ì„œ íŠ¹ì • ë°© êµ¬ë…
                    subscribeToRoom(roomId);
                }
            })
            .catch(error => console.error("âŒ Fetch error:", error));
    }

    // íŠ¹ì •ë°© êµ¬ë…(íšŒì› : ê´€ë¦¬ì ë°© )
    var subscribedRooms = new Set(); // âœ… êµ¬ë…ëœ ë°©ì„ ì €ì¥

    function subscribeToRoom(roomId) {
        if (!stompClient || !stompClient.connected) {
            console.warn(`ğŸš¨ WebSocketì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•ŠìŒ. ${roomId}ë²ˆ ë°© êµ¬ë… ëŒ€ê¸°`);
            setTimeout(() => subscribeToRoom(roomId), 1000);
            return;
        }

        // âœ… ì´ë¯¸ êµ¬ë…í•œ ë°©ì¸ì§€ í™•ì¸
        if (subscribedRooms.has(roomId)) {
            console.log(`ğŸš« ì´ë¯¸ êµ¬ë…ëœ ì±„íŒ…ë°©: roomId=${roomId}`);
            return;
        }

        console.log(`ğŸ“© [íšŒì›] ì±„íŒ…ë°© êµ¬ë…: roomId=${roomId}`);

        stompClient.subscribe(`/sub/chat/room/${roomId}`, function (message) {
            var receivedMessage = JSON.parse(message.body);
            console.log(`ğŸ“© [íšŒì›] ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹  (ìš´ì˜ìë¡œë¶€í„°):`, receivedMessage);
            displayMessage(receivedMessage);
        });

        subscribedRooms.add(roomId);
    }


    // âœ… ë©”ì‹œì§€ í™”ë©´ì— ì¶”ê°€
    function displayMessage(message) {
        var chatBody = document.getElementById("chatBody");
        var messageElement = document.createElement("div");

        // âœ… ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì˜¤ë¥¸ìª½, ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì™¼ìª½
        var isMine = (message.sender === nickName);
        messageElement.classList.add("chat-message", isMine ? "mine" : "other");

        // âœ… ë©”ì‹œì§€ë§Œ í‘œì‹œ
        messageElement.innerHTML = message.message;
        chatBody.appendChild(messageElement);

        // âœ… ìµœì‹  ë©”ì‹œì§€ë¡œ ìë™ ìŠ¤í¬ë¡¤
        chatBody.scrollTop = chatBody.scrollHeight;
    }



    // âœ… ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
        var messageInput = document.getElementById("chatMessage");
        var message = messageInput.value.trim();
        if (!message || !stompClient || !stompClient.connected) return;

        console.log("ğŸ“¤ [íšŒì›] ë©”ì‹œì§€ ì „ì†¡:", message);

        var chatMessage = {
            roomId: roomId,
            sender: nickName, // í˜„ì¬ ë¡œê·¸ì¸í•œ íšŒì›ì´ ë³´ë‚¸ ë©”ì‹œì§€
            message: message
        };

        // âœ… ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ (displayMessage() ì§ì ‘ í˜¸ì¶œ ì œê±°)
        stompClient.send("/pub/message", {}, JSON.stringify(chatMessage));

        // âœ… ë©”ì‹œì§€ëŠ” ì„œë²„ì—ì„œ ë°›ì•„ ì²˜ë¦¬ë˜ë¯€ë¡œ, ì§ì ‘ í™”ë©´ì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        messageInput.value = "";
    }


    // âœ… Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById("chatMessage").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²° ë° íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    window.addEventListener("load", function () {
        console.log("ğŸ“Œ [íšŒì› í˜ì´ì§€] WebSocket ì—°ê²° ì‹¤í–‰");
        fetchUserInfoAndConnect();
    });
</script>


<!-- âœ… í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="https://code.jquery.com/jquery-3.4.1.js"></script>

</body>
</html>
